# Cloudflare Worker - é‚®ä»¶ç®¡ç†ç³»ç»Ÿ

è¿™æ˜¯é‚®ä»¶ç®¡ç†ç³»ç»Ÿçš„ Cloudflare Worker éƒ¨åˆ†ï¼Œè´Ÿè´£æ¥æ”¶å’Œå¤„ç†æ‰€æœ‰ç±»å‹çš„é‚®ä»¶ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ“§ **æ™ºèƒ½é‚®ä»¶åˆ†ç±»**: è‡ªåŠ¨è¯†åˆ« DMARC æŠ¥å‘Šå’Œæ™®é€šé‚®ä»¶
- ğŸ”„ **è‡ªåŠ¨å¤„ç†**: é‚®ä»¶åˆ°è¾¾æ—¶è‡ªåŠ¨è§¦å‘å¤„ç†æµç¨‹
- ğŸ’¾ **æ•°æ®å­˜å‚¨**: å°†å¤„ç†åçš„æ•°æ®ä¿å­˜åˆ° UniCloud æ•°æ®åº“
- ğŸ›¡ï¸ **å®¹é”™å¤„ç†**: å¤„ç†å¤±è´¥çš„é‚®ä»¶ä¹Ÿä¼šä¿å­˜åŸºæœ¬ä¿¡æ¯
- ğŸ“Š **å¯é€‰åˆ†æ**: æ”¯æŒ Analytics Engine å¤‡ä»½åˆ†æ

## æ”¯æŒçš„é‚®ä»¶ç±»å‹

### 1. DMARC æŠ¥å‘Š (`dmarc`)
- è‡ªåŠ¨è§£æ XML æŠ¥å‘Šå†…å®¹
- æ”¯æŒ `.gz`ã€`.zip`ã€`.xml` æ ¼å¼é™„ä»¶
- æå–ç»“æ„åŒ–çš„å®‰å…¨æ•°æ®

### 2. æ™®é€šé‚®ä»¶ (`regular`)
- ä¿å­˜å®Œæ•´çš„é‚®ä»¶å†…å®¹
- æ”¯æŒ HTML å’Œçº¯æ–‡æœ¬æ ¼å¼
- ä¿å­˜é™„ä»¶ä¿¡æ¯

### 3. é”™è¯¯é‚®ä»¶ (`error`)
- å¤„ç†å¤±è´¥æ—¶çš„å¤‡ç”¨ä¿å­˜
- è®°å½•é”™è¯¯ä¿¡æ¯ä¾¿äºè°ƒè¯•

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–
```bash
npm install
```

### 2. é…ç½®ç¯å¢ƒ
ç¼–è¾‘ `wrangler.toml` æ–‡ä»¶ï¼Œè®¾ç½®ä½ çš„ UniCloud å‡½æ•° URLï¼š
```toml
[vars]
UNICLOUD_URL = "https://your-actual-unicloud-function-url"
```

### 3. æœ¬åœ°å¼€å‘
```bash
npm run start
```

### 4. éƒ¨ç½²åˆ° Cloudflare
```bash
npm run deploy
```

## é…ç½®è¯´æ˜

### å¿…éœ€é…ç½®
- `UNICLOUD_URL`: UniCloud äº‘å‡½æ•°çš„ HTTP è§¦å‘ URL

### å¯é€‰é…ç½®
å¦‚æœéœ€è¦é¢å¤–åŠŸèƒ½ï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Šï¼š

```toml
# R2 å¯¹è±¡å­˜å‚¨ï¼ˆå¤‡ä»½åŸå§‹é™„ä»¶ï¼‰
[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "your-bucket-name"

# Analytics Engineï¼ˆæ•°æ®åˆ†æï¼‰
[[analytics_engine_datasets]]
binding = "DMARC_ANALYTICS"
dataset = "dmarc_reports"
```

## é‚®ä»¶è·¯ç”±é…ç½®

åœ¨ Cloudflare Dashboard ä¸­é…ç½® Email Routingï¼š

1. è¿›å…¥åŸŸåç®¡ç† â†’ ç”µå­é‚®ä»¶ â†’ ç”µå­é‚®ä»¶è·¯ç”±
2. æ·»åŠ è·¯ç”±è§„åˆ™ï¼š
   - **Catch-All** â†’ å‘é€åˆ° Worker â†’ `email-management-worker`
   - æˆ–é…ç½®ç‰¹å®šåœ°å€ â†’ å‘é€åˆ° Worker â†’ `email-management-worker`

## æ•°æ®æµå‘

```
é‚®ä»¶å‘é€ â†’ Cloudflare Email Routing â†’ Worker å¤„ç† â†’ UniCloud å­˜å‚¨
```

## å¼€å‘å‘½ä»¤

```bash
# æœ¬åœ°å¼€å‘
npm run start

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
npm run deploy

# ä»£ç æ ¼å¼åŒ–
npm run pretty

# ä»£ç æ£€æŸ¥
npm run lint

# è¿è¡Œæµ‹è¯•
npm test
```

## ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹ Worker æ—¥å¿—
```bash
npx wrangler tail
```

### å¸¸è§é—®é¢˜

1. **é‚®ä»¶å¤„ç†å¤±è´¥**
   - æ£€æŸ¥ UniCloud URL æ˜¯å¦æ­£ç¡®
   - éªŒè¯ç½‘ç»œè¿æ¥
   - æŸ¥çœ‹ Worker æ—¥å¿—

2. **DMARC æŠ¥å‘Šè§£æå¤±è´¥**
   - æ£€æŸ¥é™„ä»¶æ ¼å¼æ˜¯å¦æ”¯æŒ
   - éªŒè¯ XML ç»“æ„æ˜¯å¦æ­£ç¡®

3. **æ•°æ®ä¿å­˜å¤±è´¥**
   - æ£€æŸ¥ UniCloud å‡½æ•°çŠ¶æ€
   - éªŒè¯æ•°æ®åº“æƒé™

## å®‰å…¨å»ºè®®

- å®šæœŸæ›´æ–°ä¾èµ–åŒ…
- ç›‘æ§ Worker æ‰§è¡Œæ—¥å¿—
- è®¾ç½®é€‚å½“çš„é”™è¯¯å‘Šè­¦
- è€ƒè™‘æ·»åŠ è®¿é—®æ§åˆ¶

## æ‰©å±•åŠŸèƒ½

å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ ï¼š
- é‚®ä»¶è½¬å‘åŠŸèƒ½
- è‡ªåŠ¨å›å¤æœºåˆ¶
- åƒåœ¾é‚®ä»¶è¿‡æ»¤
- è‡ªå®šä¹‰å¤„ç†è§„åˆ™

## æŠ€æœ¯æ ˆ

- **Runtime**: Cloudflare Workers
- **Language**: TypeScript
- **Email Parsing**: postal-mime
- **XML Processing**: fast-xml-parser
- **Compression**: pako, unzipit
- **Build Tool**: Wrangler